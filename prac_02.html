<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quick MNIST Demo</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
<style>
    canvas { border:1px solid black; cursor: crosshair; }
    button { margin:5px; padding:10px; font-size:16px; }
</style>
</head>
<body>
<h2>Quick MNIST Demo (Tiny In-Browser CNN)</h2>
<p>Draw a digit 0-9:</p>
<canvas id="drawCanvas" width="140" height="140"></canvas><br>
<button id="clearBtn">Clear</button>
<button id="predictBtn">Predict</button>
<p id="status">Model will train for 2 seconds...</p>
<p id="prediction"></p>

<script>
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
ctx.fillStyle="white"; ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.strokeStyle="black"; ctx.lineWidth=12; ctx.lineCap="round";

let drawing=false;
canvas.addEventListener('mousedown',()=>drawing=true);
canvas.addEventListener('mouseup',()=>{drawing=false; ctx.beginPath();});
canvas.addEventListener('mousemove',e=>{if(!drawing)return;
    const r=canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX-r.left,e.clientY-r.top);
    ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX-r.left,e.clientY-r.top);
});

document.getElementById('clearBtn').onclick=()=>{
    ctx.fillStyle="white"; ctx.fillRect(0,0,canvas.width,canvas.height);
    document.getElementById('prediction').innerText="";
}

// Generate synthetic tiny MNIST-like data
function generateData(num=100){
    const xs=[], ys=[];
    for(let i=0;i<num;i++){
        const img = tf.randomUniform([28,28,1]); xs.push(img);
        const label = tf.oneHot(Math.floor(Math.random()*10),10); ys.push(label);
    }
    return {xs: tf.stack(xs), ys: tf.stack(ys)};
}

// Build tiny CNN
const model = tf.sequential();
model.add(tf.layers.conv2d({inputShape:[28,28,1], filters:8,kernelSize:3,activation:'relu'}));
model.add(tf.layers.maxPooling2d({poolSize:2}));
model.add(tf.layers.flatten());
model.add(tf.layers.dense({units:32, activation:'relu'}));
model.add(tf.layers.dense({units:10, activation:'softmax'}));
model.compile({optimizer:'adam', loss:'categoricalCrossentropy', metrics:['accuracy']});

// Train quickly in-browser
(async()=>{
    const data = generateData(200);
    await model.fit(data.xs,data.ys,{epochs:2,batchSize:32});
    document.getElementById('status').innerText="Model ready!";
})();

// Convert canvas to 28x28 tensor
function getInputTensor(){
    const temp = document.createElement('canvas');
    temp.width=28; temp.height=28;
    temp.getContext('2d').drawImage(canvas,0,0,28,28);
    const data = temp.getContext('2d').getImageData(0,0,28,28).data;
    const arr=[];
    for(let i=0;i<data.length;i+=4){
        const gray=(data[i]+data[i+1]+data[i+2])/3;
        arr.push((255-gray)/255);
    }
    return tf.tensor4d(arr,[1,28,28,1]);
}

// Predict
document.getElementById('predictBtn').onclick=()=>{
    const input=getInputTensor();
    const output=model.predict(input);
    output.data().then(probs=>{
        const pred=probs.indexOf(Math.max(...probs));
        document.getElementById('prediction').innerText="Predicted digit: "+pred;
    });
}
</script>
</body>
</html>
